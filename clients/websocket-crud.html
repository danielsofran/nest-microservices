<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Client</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
      #eventLog {
          height: 300px;
          overflow-y: auto;
          background-color: #f8f9fa;
          border-radius: 5px;
          padding: 10px;
          margin-bottom: 10px;
      }
      .log-entry {
          margin-bottom: 5px;
          padding: 5px;
          border-bottom: 1px solid #eee;
      }
  </style>
</head>
<body>
<div class="container mt-4">
  <h1 class="mb-4">WebSocket Client</h1>

  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <label for="resourceInput" class="form-label">Resource Name</label>
          <input type="text" class="form-control" id="resourceInput" placeholder="e.g., user" value="products">
        </div>
        <div class="col-md-6 d-flex align-items-end">
          <button id="connectBtn" class="btn btn-primary me-2">Connect</button>
          <button id="disconnectBtn" class="btn btn-danger" disabled>Disconnect</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Event Log</h5>
      <div id="eventLog"></div>
      <button id="clearLogBtn" class="btn btn-sm btn-outline-secondary mt-2">Clear Log</button>
    </div>
  </div>
</div>

<!-- Bootstrap 5 JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Socket.io client -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
  let socket = null;
  const connectBtn = document.getElementById('connectBtn');
  const disconnectBtn = document.getElementById('disconnectBtn');
  const resourceInput = document.getElementById('resourceInput');
  const eventLog = document.getElementById('eventLog');
  const clearLogBtn = document.getElementById('clearLogBtn');

  function logEvent(message, data = null) {
    const entry = document.createElement('div');
    entry.className = 'log-entry';

    const timestamp = new Date().toLocaleTimeString();
    entry.innerHTML = `<strong>[${timestamp}] ${message}</strong>`;

    if (data) {
      const pre = document.createElement('pre');
      pre.textContent = JSON.stringify(data, null, 2);
      entry.appendChild(pre);
    }

    eventLog.appendChild(entry);
    eventLog.scrollTop = eventLog.scrollHeight;
  }

  function connect() {
    const resourceName = resourceInput.value.trim();
    if (!resourceName) {
      alert('Please enter a resource name');
      return;
    }

    const wsUrl = `ws://localhost:7000/${resourceName}/events`;
    logEvent(`Connecting to ${wsUrl}...`);

    socket = io(wsUrl);
    console.log(`Connecting to WebSocket at ${wsUrl}`, io, socket)

    socket.on('connected', () => {
      logEvent('Connected successfully');
      connectBtn.disabled = true;
      disconnectBtn.disabled = false;
      resourceInput.disabled = true;
    });

    socket.on('disconnect', () => {
      logEvent('Disconnected');
      connectBtn.disabled = false;
      disconnectBtn.disabled = true;
      resourceInput.disabled = false;
    });

    socket.on('created', (data) => {
      logEvent('CREATED event received', data);
    });

    socket.on('updated', (data) => {
      logEvent('UPDATED event received', data);
    });

    socket.on('deleted', (data) => {
      logEvent('DELETED event received', data);
    });

    socket.on('error', (error) => {
      logEvent('Error:', error);
    });
  }

  function disconnect() {
    if (socket) {
      logEvent('Disconnecting...');
      socket.disconnect();
      socket = null;
    }
  }

  connectBtn.addEventListener('click', connect);
  disconnectBtn.addEventListener('click', disconnect);
  clearLogBtn.addEventListener('click', () => {
    eventLog.innerHTML = '';
  });

  // Handle Enter key in resource input
  resourceInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      connect();
    }
  });
</script>
</body>
</html>